<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGL IonGraph Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1a1a2e;
            color: white;
        }
        #controls {
            margin-bottom: 10px;
        }
        #controls button {
            margin-right: 10px;
            padding: 8px 16px;
            cursor: pointer;
        }
        #controls input[type="file"] {
            margin-right: 10px;
        }
        canvas {
            border: 1px solid #333;
            background: #f5f5f5;
        }
        #info {
            margin-top: 10px;
            font-size: 14px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <h1>WebGL IonGraph Test</h1>
    <div id="controls">
        <input type="file" id="fileInput" accept=".json">
        <button id="prevFunc">Prev Func</button>
        <button id="nextFunc">Next Func</button>
        <button id="prevPass">Prev Pass</button>
        <button id="nextPass">Next Pass</button>
        <button id="resetView">Reset View</button>
    </div>
    <canvas id="canvas" width="1200" height="800"></canvas>
    <div id="info">Load an IonJSON file to begin.</div>

    <script type="module">
        import init, { WebGLIonGraphViewer } from './pkg/iongraph_rust_redux.js';

        let viewer = null;

        async function initialize() {
            await init();
            console.log('WASM initialized');
        }

        function updateInfo() {
            if (!viewer) return;
            const funcIdx = viewer.get_current_function();
            const passIdx = viewer.get_current_pass();
            const funcCount = viewer.get_function_count();
            const passCount = viewer.get_pass_count();
            const funcName = viewer.get_function_name(funcIdx);
            const passName = viewer.get_pass_name(funcIdx, passIdx);
            const debugInfo = viewer.debug_scene_info();

            document.getElementById('info').textContent =
                `Function ${funcIdx + 1}/${funcCount}: ${funcName} | ` +
                `Pass ${passIdx + 1}/${passCount}: ${passName} | ` +
                debugInfo;
        }

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const jsonText = await file.text();
            try {
                viewer = new WebGLIonGraphViewer('canvas', jsonText);
                console.log('Viewer created');
                updateInfo();

                // Set up event listeners
                const canvas = document.getElementById('canvas');
                canvas.addEventListener('mousedown', (e) => viewer.on_mouse_down(e));
                canvas.addEventListener('mouseup', (e) => viewer.on_mouse_up(e));
                canvas.addEventListener('mousemove', (e) => viewer.on_mouse_move(e));
                canvas.addEventListener('wheel', (e) => { e.preventDefault(); viewer.on_wheel(e); }, { passive: false });
                document.addEventListener('keydown', async (e) => {
                    const navigated = await viewer.on_key_down(e);
                    if (navigated) updateInfo();
                });
            } catch (err) {
                console.error('Failed to create viewer:', err);
                document.getElementById('info').textContent = 'Error: ' + err;
            }
        });

        document.getElementById('prevFunc').addEventListener('click', () => {
            if (viewer) { viewer.prev_function(); updateInfo(); }
        });
        document.getElementById('nextFunc').addEventListener('click', () => {
            if (viewer) { viewer.next_function(); updateInfo(); }
        });
        document.getElementById('prevPass').addEventListener('click', () => {
            if (viewer) { viewer.prev_pass(); updateInfo(); }
        });
        document.getElementById('nextPass').addEventListener('click', () => {
            if (viewer) { viewer.next_pass(); updateInfo(); }
        });
        document.getElementById('resetView').addEventListener('click', () => {
            if (viewer) { viewer.reset_view(); }
        });

        initialize();
    </script>
</body>
</html>
