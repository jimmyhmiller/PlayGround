<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IonGraph WebGL Viewer</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: #16213e;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            border-bottom: 1px solid #0f3460;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #e94560;
        }

        .file-input-wrapper {
            position: relative;
        }

        .file-input-wrapper input[type="file"] {
            display: none;
        }

        .file-input-wrapper label {
            display: inline-block;
            padding: 8px 16px;
            background: #e94560;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .file-input-wrapper label:hover {
            background: #ff6b6b;
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: auto;
        }

        .nav-controls select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #0f3460;
            background: #16213e;
            color: #eee;
            font-size: 14px;
            min-width: 200px;
            cursor: pointer;
        }

        .nav-controls select:focus {
            outline: none;
            border-color: #e94560;
        }

        .nav-controls button {
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            background: #0f3460;
            color: #eee;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .nav-controls button:hover {
            background: #1a4a7a;
        }

        .nav-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .info-bar {
            background: #0f3460;
            padding: 8px 20px;
            font-size: 13px;
            color: #aaa;
            display: flex;
            gap: 20px;
            flex-shrink: 0;
        }

        .info-bar span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .info-bar .label {
            color: #666;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #graph-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .welcome {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
        }

        .welcome h2 {
            font-size: 24px;
            margin-bottom: 12px;
            color: #888;
        }

        .welcome p {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .welcome .keys {
            margin-top: 20px;
            font-size: 12px;
            color: #555;
        }

        .welcome kbd {
            display: inline-block;
            padding: 2px 6px;
            background: #2a2a4a;
            border-radius: 3px;
            font-family: monospace;
            margin: 0 2px;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #e94560;
            max-width: 400px;
        }

        .error h3 {
            margin-bottom: 8px;
        }

        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            background: rgba(22, 33, 62, 0.9);
            padding: 8px;
            border-radius: 8px;
        }

        .zoom-controls button {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: none;
            background: #0f3460;
            color: #eee;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .zoom-controls button:hover {
            background: #1a4a7a;
        }

        .zoom-controls .zoom-level {
            padding: 0 12px;
            display: flex;
            align-items: center;
            font-size: 13px;
            color: #aaa;
            min-width: 60px;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>IonGraph WebGL</h1>
        <div class="file-input-wrapper">
            <input type="file" id="file-input" accept=".json">
            <label for="file-input">Load IonJSON File</label>
        </div>
        <div class="nav-controls hidden" id="nav-controls">
            <select id="function-select" title="Select function"></select>
            <select id="pass-select" title="Select pass"></select>
            <button id="prev-pass" title="Previous pass (Left Arrow)">&larr;</button>
            <button id="next-pass" title="Next pass (Right Arrow)">&rarr;</button>
        </div>
    </div>

    <div class="info-bar hidden" id="info-bar">
        <span><span class="label">Function:</span> <span id="current-function">-</span></span>
        <span><span class="label">Pass:</span> <span id="current-pass">-</span></span>
        <span><span class="label">Selected:</span> <span id="selected-blocks">None</span></span>
        <span><span class="label">Hover:</span> <span id="hovered-block">-</span></span>
    </div>

    <div class="canvas-container" id="canvas-container">
        <canvas id="graph-canvas"></canvas>

        <div class="welcome" id="welcome">
            <h2>IonGraph WebGL Viewer</h2>
            <p>Load an IonJSON file to visualize SpiderMonkey JIT graphs</p>
            <div class="keys">
                <p><kbd>Click</kbd> Select block &nbsp; <kbd>Ctrl+Click</kbd> Multi-select</p>
                <p><kbd>Drag</kbd> Pan &nbsp; <kbd>Scroll</kbd> Pan &nbsp; <kbd>Ctrl+Scroll</kbd> Zoom</p>
                <p><kbd>&larr;</kbd><kbd>&rarr;</kbd> Navigate passes &nbsp; <kbd>Esc</kbd> Clear selection</p>
            </div>
        </div>

        <div class="loading hidden" id="loading">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>

        <div class="error hidden" id="error">
            <h3>Error</h3>
            <p id="error-message"></p>
        </div>

        <div class="zoom-controls hidden" id="zoom-controls">
            <button id="zoom-out" title="Zoom out">-</button>
            <span class="zoom-level" id="zoom-level">100%</span>
            <button id="zoom-in" title="Zoom in">+</button>
            <button id="zoom-reset" title="Reset view">&#8634;</button>
        </div>
    </div>

    <script type="module">
        import init, { WebGLIonGraphViewer } from './pkg/iongraph_rust_redux.js';

        let viewer = null;
        let wasm = null;

        // DOM elements
        const fileInput = document.getElementById('file-input');
        const canvas = document.getElementById('graph-canvas');
        const welcome = document.getElementById('welcome');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const errorMessage = document.getElementById('error-message');
        const navControls = document.getElementById('nav-controls');
        const infoBar = document.getElementById('info-bar');
        const zoomControls = document.getElementById('zoom-controls');
        const functionSelect = document.getElementById('function-select');
        const passSelect = document.getElementById('pass-select');
        const prevPassBtn = document.getElementById('prev-pass');
        const nextPassBtn = document.getElementById('next-pass');
        const currentFunctionEl = document.getElementById('current-function');
        const currentPassEl = document.getElementById('current-pass');
        const selectedBlocksEl = document.getElementById('selected-blocks');
        const hoveredBlockEl = document.getElementById('hovered-block');
        const zoomLevelEl = document.getElementById('zoom-level');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const zoomResetBtn = document.getElementById('zoom-reset');

        // Initialize WASM
        async function initWasm() {
            try {
                wasm = await init();
                console.log('WASM initialized');
            } catch (e) {
                showError('Failed to initialize WebGL renderer: ' + e.message);
            }
        }

        // Show/hide UI states
        function showWelcome() {
            welcome.classList.remove('hidden');
            loading.classList.add('hidden');
            error.classList.add('hidden');
            navControls.classList.add('hidden');
            infoBar.classList.add('hidden');
            zoomControls.classList.add('hidden');
        }

        function showLoading() {
            welcome.classList.add('hidden');
            loading.classList.remove('hidden');
            error.classList.add('hidden');
        }

        function showError(msg) {
            welcome.classList.add('hidden');
            loading.classList.add('hidden');
            error.classList.remove('hidden');
            errorMessage.textContent = msg;
            navControls.classList.add('hidden');
            infoBar.classList.add('hidden');
            zoomControls.classList.add('hidden');
        }

        function showViewer() {
            welcome.classList.add('hidden');
            loading.classList.add('hidden');
            error.classList.add('hidden');
            navControls.classList.remove('hidden');
            infoBar.classList.remove('hidden');
            zoomControls.classList.remove('hidden');
        }

        // Resize canvas to container
        function resizeCanvas() {
            const container = document.getElementById('canvas-container');
            const dpr = window.devicePixelRatio || 1;
            const width = container.clientWidth;
            const height = container.clientHeight;

            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';

            if (viewer) {
                viewer.on_resize(canvas.width, canvas.height);
            }
        }

        // Populate function dropdown
        function populateFunctions() {
            functionSelect.innerHTML = '';
            const count = viewer.get_function_count();
            for (let i = 0; i < count; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = viewer.get_function_name(i);
                functionSelect.appendChild(option);
            }
            functionSelect.value = viewer.get_current_function();
        }

        // Populate pass dropdown
        function populatePasses() {
            passSelect.innerHTML = '';
            const funcIdx = viewer.get_current_function();
            const count = viewer.get_pass_count();
            for (let i = 0; i < count; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = viewer.get_pass_name(funcIdx, i);
                passSelect.appendChild(option);
            }
            passSelect.value = viewer.get_current_pass();
        }

        // Update info bar
        function updateInfo() {
            const funcIdx = viewer.get_current_function();
            const passIdx = viewer.get_current_pass();

            currentFunctionEl.textContent = viewer.get_function_name(funcIdx);
            currentPassEl.textContent = viewer.get_pass_name(funcIdx, passIdx);

            const selected = viewer.get_selected_blocks();
            selectedBlocksEl.textContent = selected.length > 0 ? selected.join(', ') : 'None';

            const hovered = viewer.get_hovered_block();
            hoveredBlockEl.textContent = hovered || '-';

            const zoom = viewer.get_zoom();
            zoomLevelEl.textContent = Math.round(zoom * 100) + '%';

            // Update button states
            prevPassBtn.disabled = passIdx === 0;
            nextPassBtn.disabled = passIdx >= viewer.get_pass_count() - 1;
        }

        // Load IonJSON file
        async function loadFile(file) {
            showLoading();

            try {
                const text = await file.text();

                // Destroy existing viewer
                if (viewer) {
                    viewer = null;
                }

                // Resize canvas first
                resizeCanvas();

                // Create new viewer
                viewer = new WebGLIonGraphViewer('graph-canvas', text);

                // Set up UI
                populateFunctions();
                populatePasses();
                updateInfo();
                showViewer();

                // Debug output
                console.log('Scene info:', viewer.debug_scene_info());

            } catch (e) {
                showError('Failed to load file: ' + e.message);
                console.error(e);
            }
        }

        // Event handlers
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                loadFile(file);
            }
        });

        functionSelect.addEventListener('change', () => {
            const funcIdx = parseInt(functionSelect.value);
            viewer.navigate(funcIdx, 0);
            populatePasses();
            updateInfo();
            console.log('After navigate:', viewer.debug_scene_info());
        });

        passSelect.addEventListener('change', () => {
            const funcIdx = parseInt(functionSelect.value);
            const passIdx = parseInt(passSelect.value);
            viewer.navigate(funcIdx, passIdx);
            updateInfo();
            console.log('After navigate:', viewer.debug_scene_info());
        });

        prevPassBtn.addEventListener('click', () => {
            viewer.prev_pass();
            passSelect.value = viewer.get_current_pass();
            updateInfo();
        });

        nextPassBtn.addEventListener('click', () => {
            viewer.next_pass();
            passSelect.value = viewer.get_current_pass();
            updateInfo();
        });

        zoomInBtn.addEventListener('click', () => {
            viewer.set_zoom(viewer.get_zoom() * 1.2);
            updateInfo();
        });

        zoomOutBtn.addEventListener('click', () => {
            viewer.set_zoom(viewer.get_zoom() / 1.2);
            updateInfo();
        });

        zoomResetBtn.addEventListener('click', () => {
            viewer.reset_view();
            updateInfo();
        });

        // Canvas events
        canvas.addEventListener('mousedown', (e) => {
            if (viewer) {
                viewer.on_mouse_down(e);
                updateInfo();
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            if (viewer) {
                viewer.on_mouse_up(e);
                updateInfo();
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (viewer) {
                viewer.on_mouse_move(e);
                // Update hover info
                const hovered = viewer.get_hovered_block();
                hoveredBlockEl.textContent = hovered || '-';
            }
        });

        canvas.addEventListener('wheel', (e) => {
            if (viewer) {
                e.preventDefault();
                viewer.on_wheel(e);
                updateInfo();
            }
        }, { passive: false });

        document.addEventListener('keydown', (e) => {
            if (viewer) {
                const navigated = viewer.on_key_down(e);
                if (navigated) {
                    passSelect.value = viewer.get_current_pass();
                    functionSelect.value = viewer.get_current_function();
                    populatePasses();
                }
                updateInfo();
            }
        });

        window.addEventListener('resize', () => {
            resizeCanvas();
        });

        // Drag and drop support
        document.body.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
        });

        document.body.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.json')) {
                loadFile(file);
            }
        });

        // Initialize
        initWasm().then(() => {
            resizeCanvas();
            showWelcome();
        });
    </script>
</body>
</html>
