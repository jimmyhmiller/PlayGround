# Ad-hoc Testing

This feature allows you to test the Java JavaScript parser against any npm package or local JavaScript project.

## Two Modes

1. **Cached Mode** (`test-package.js`): Generates a cache with Acorn, then runs Java tests
2. **Real-time Mode** (`DirectoryTester`): Parses files with both Acorn and Java on-the-fly, no caching

## Quick Start

### Real-time Mode (Recommended)

Test any directory with immediate comparison, no caching:

```bash
# Simple wrapper (recommended)
./test-dir ../my-project
./test-dir ../my-project --max-failures=10

# Or use Maven directly
mvn exec:java -Dexec.mainClass="com.jsparser.DirectoryTester" -Dexec.args="../my-project"
mvn exec:java -Dexec.mainClass="com.jsparser.DirectoryTester" -Dexec.args="../my-project --max-failures=10"
```

### Cached Mode (For repeated testing)

Generate a cache first, then run tests (useful if you'll test the same directory multiple times):

```bash
# Generate cache
node scripts/test-package.js <package-name>
# or
node scripts/test-package.js /path/to/directory

# Run tests against cache
mvn test -Dtest=AdhocPackageTest -DpackageName=<package-name>
```

## Examples

### Test lodash.debounce

```bash
node scripts/test-package.js lodash.debounce
mvn test -Dtest=AdhocPackageTest -DpackageName=lodash.debounce
```

### Test express

```bash
node scripts/test-package.js express
mvn test -Dtest=AdhocPackageTest -DpackageName=express
```

### Test any random directory

```bash
# Test your scripts directory
node scripts/test-package.js ./scripts
mvn test -Dtest=AdhocPackageTest -DpackageName=scripts

# Test a sibling project
node scripts/test-package.js ../ai-dashboard2
mvn test -Dtest=AdhocPackageTest -DpackageName=ai-dashboard2

# Test any directory on your system
node scripts/test-package.js ~/Documents/projects/my-app
mvn test -Dtest=AdhocPackageTest -DpackageName=my-app
```

## How it Works

### Real-time Mode (DirectoryTester)

1. Recursively scans the directory for all `.js` and `.mjs` files
2. For each file:
   - Parses with Acorn via Node.js subprocess
   - Parses with Java parser
   - Compares ASTs immediately
3. Reports results in real-time
4. **No caching** - everything happens on-the-fly
5. Use `--max-failures=N` to stop early after N failures

**Advantages:**
- No cache files to manage
- Immediate feedback
- Perfect for ad-hoc testing
- Can stop early with `--max-failures`

### Cached Mode (test-package.js + AdhocPackageTest)

1. **Node.js Script (`test-package.js`)**:
   - Installs the npm package (if needed) or uses a local directory
   - Recursively scans for JavaScript files (`.js` and `.mjs`)
   - Parses each file with Acorn (the reference parser)
   - Generates a cache of ASTs for files that Acorn can parse
   - Saves results to `test-oracles/adhoc-cache/<package-name>/`

2. **Java Test (`AdhocPackageTest`)**:
   - Reads the cache generated by the Node.js script
   - Parses each file with the Java parser
   - Compares the AST output with Acorn's output
   - Reports matches, mismatches, and failures

**Advantages:**
- Faster for repeated testing
- Can test multiple times without re-parsing with Acorn
- Good for regression testing

## Configuration

### Excluding Directories

By default, these directories are excluded:
- `node_modules`
- `.git`
- `test`, `tests`, `__tests__`
- `coverage`
- `dist`, `build`
- Hidden directories (starting with `.`)

To customize, edit the `collectJsFiles()` function in `scripts/test-package.js`.

### File Size Limit

Files larger than 500KB are skipped by default. To adjust, modify the size check in `processFile()`.

## Output

### Node.js Script Output

```
=== Results ===
Total files: 150
✓ Successfully parsed: 145 (96.67%)
✗ Failed to parse: 3 (2.00%)
⊘ Skipped: 2 (1.33%)

Cache directory: test-oracles/adhoc-cache/express
```

### Java Test Output

```
=== Test Results ===
Total files tested: 145
  ✓ Exact matches: 142 (97.93%)
  ✗ AST mismatches: 2 (1.38%)
  ⚠ Parse failures: 1 (0.69%)
```

## Troubleshooting

### Package not found

If you get "Package not found", ensure the package name is correct:
```bash
npm search <package-name>
```

### Cache directory not found

Run the Node.js script first before running the Java test:
```bash
node scripts/test-package.js <package-name>
```

### Permission errors

Some packages may have permission-restricted files. These will be automatically skipped.

## Cache Location

All caches are stored in:
```
test-oracles/adhoc-cache/<package-name>/
```

Each cache directory contains:
- `*.js.json` - Individual AST cache files
- `_summary.json` - Test summary with metadata

Temporary package installations go to:
```
temp-packages/<package-name>/
```

## Clean Up

To remove cached data:

```bash
# Remove all ad-hoc caches
rm -rf test-oracles/adhoc-cache

# Remove temporary package installations
rm -rf temp-packages
```

## Tips

- Start with small packages to verify the setup works
- Use popular, well-maintained packages for comprehensive testing
- Check the summary file to see which files were successfully parsed
- Failed files in the Node.js script won't be tested by Java (Acorn couldn't parse them)
